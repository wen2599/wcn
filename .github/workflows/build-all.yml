name: 构建并发布 Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      KEYSTORE_B64:     ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      KEY_ALIAS:        ${{ secrets.ANDROID_KEY_ALIAS }}
      KEY_PASSWORD:     ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 安装 JDK 和 Node.js
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: 安装 Android SDK
        uses: android-actions/setup-android@v3

      - name: 安装前端依赖
        run: |
          npm install
          cd frontend && npm install

      - name: 构建前端项目
        run: npm run build -w frontend

      - name: Capacitor 同步 Android
        run: npx cap sync android

      - name: 解码并生成 keystore
        run: |
          echo "$KEYSTORE_B64" | base64 --decode > my-release-key.keystore
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

      - name: 授予 gradlew 可执行权限
        run: chmod +x android/gradlew

      - name: 生成版本信息
        id: versioning
        run: |
          echo "version_name=dev-$(date +'%Y%m%d')-${{ github.sha_short }}" >> $GITHUB_OUTPUT
          echo "version_code=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: 打包签名 Release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            -PappVersionCode=${{ steps.versioning.outputs.version_code }} \
            -PappVersionName=${{ steps.versioning.outputs.version_name }} \
            -Pandroid.injected.signing.store.file="${{ github.workspace }}/my-release-key.keystore" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: 重命名 APK
        run: |
          mv android/app/build/outputs/apk/release/app-release.apk \
             android/app/build/outputs/apk/release/摆牌-${{ steps.versioning.outputs.version_name }}.apk

      - name: 创建 GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: release-${{ github.sha }}
          name: "自动构建 - ${{ github.event.head_commit.message }}"
          artifacts: "android/app/build/outputs/apk/release/*.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          body: |
            此版由 CI 自动生成  
            Commit: `${{ github.sha }}`  
            版本名: `${{ steps.versioning.outputs.version_name }}`  
            版本码: `${{ steps.versioning.outputs.version_code }}`
